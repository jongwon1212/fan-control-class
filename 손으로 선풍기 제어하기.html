<!DOCTYPE html>
<html>
<head>
  <title>USB ì‹œë¦¬ì–¼ ì—°ê²° - ì† ì¸ì‹ ì„ í’ê¸° ì œì–´</title>
  <meta charset="UTF-8">
  <style>
    body { 
      font-family: sans-serif; 
      text-align: center; 
      margin-top: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      max-width: 600px;
      margin: 0 auto;
    }
    input {
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin: 10px;
      width: 300px;
    }
    button {
      background: linear-gradient(45deg, #ff6b6b, #feca57);
      color: white;
      border: none;
      padding: 12px 25px;
      margin: 10px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    #status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.2);
      font-size: 18px;
      font-weight: bold;
    }
    #webcam {
      border: 3px solid #fff;
      border-radius: 15px;
      margin: 20px;
    }
    .prediction-info {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .info-box {
      background: rgba(255, 165, 0, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid orange;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ”Œ USB ì‹œë¦¬ì–¼ ì—°ê²° - ì† ì¸ì‹ ì„ í’ê¸° ì œì–´</h2>
    
    <div class="info-box">
      <strong>ğŸ“‹ ì‚¬ìš©ë²•:</strong><br>
      1. ë§ˆì´í¬ë¡œë¹„íŠ¸ë¥¼ USBë¡œ ì—°ê²°<br>
      2. í‹°ì²˜ë¸” ë¨¸ì‹  ëª¨ë¸ URL ì…ë ¥<br>
      3. ì‹œë¦¬ì–¼ ì—°ê²° í›„ ëª¨ë¸ ì‹œì‘<br>
      4. ì†ë™ì‘ìœ¼ë¡œ ì„ í’ê¸° ì œì–´!
    </div>
    
    <input id="modelURL" placeholder="https://teachablemachine.withgoogle.com/models/abcd1234/" size="50">
    <br><br>
    <button onclick="connectSerial()">1ï¸âƒ£ ì‹œë¦¬ì–¼ ì—°ê²°</button>
    <button onclick="startSystem()">2ï¸âƒ£ ëª¨ë¸ ì‹œì‘í•˜ê¸°</button>
    <button onclick="disconnectSerial()">ì—°ê²° í•´ì œ</button>
    <br><br>
    
    <div id="status">USB ì¼€ì´ë¸”ë¡œ ë§ˆì´í¬ë¡œë¹„íŠ¸ë¥¼ ì—°ê²°í•˜ê³  "ì‹œë¦¬ì–¼ ì—°ê²°"ì„ í´ë¦­í•˜ì„¸ìš”</div>
    
    <div id="webcam-container">
      <video id="webcam" autoplay width="200" height="200"></video>
    </div>
    
    <div id="predictionInfo" class="prediction-info" style="display:none;">
      <div id="currentPrediction">ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
      <div id="confidenceLevel">ì‹ ë¢°ë„: 0%</div>
      <div id="lastCommand">ë§ˆì§€ë§‰ ëª…ë ¹: ì—†ìŒ</div>
    </div>
  </div>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <!-- TeachableMachine image -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  
  <script>
    let model, webcam, previousLabel = "";
    let port = null;
    let writer = null;
    let isConnected = false;
    
    function updateStatus(message, color = '#fff') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.style.color = color;
    }
    
    async function connectSerial() {
      try {
        if (!('serial' in navigator)) {
          alert('âŒ ì›¹ ì‹œë¦¬ì–¼ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•˜ì„¸ìš”.');
          return;
        }
        
        updateStatus('ì‹œë¦¬ì–¼ í¬íŠ¸ ì„ íƒ ì¤‘...', '#feca57');
        
        // ì‹œë¦¬ì–¼ í¬íŠ¸ ìš”ì²­
        port = await navigator.serial.requestPort();
        
        // ì‹œë¦¬ì–¼ í¬íŠ¸ ì—´ê¸° (ë§ˆì´í¬ë¡œë¹„íŠ¸ëŠ” ë³´í†µ 115200 baud rate)
        await port.open({ baudRate: 115200 });
        
        // Writer ìƒì„±
        writer = port.writable.getWriter();
        isConnected = true;
        
        updateStatus('âœ… ì‹œë¦¬ì–¼ ì—°ê²° ì™„ë£Œ!', '#4ecdc4');
        
        // ì—°ê²° í…ŒìŠ¤íŠ¸
        await sendCommand("HELLO");
        
      } catch (error) {
        updateStatus('âŒ ì‹œë¦¬ì–¼ ì—°ê²° ì‹¤íŒ¨: ' + error.message, '#ff6b6b');
        console.error('ì‹œë¦¬ì–¼ ì—°ê²° ì˜¤ë¥˜:', error);
      }
    }
    
    async function disconnectSerial() {
      try {
        if (writer) {
          writer.releaseLock();
          writer = null;
        }
        if (port) {
          await port.close();
          port = null;
        }
        isConnected = false;
        updateStatus('ì‹œë¦¬ì–¼ ì—°ê²° í•´ì œë¨', '#fff');
      } catch (error) {
        console.error('ì—°ê²° í•´ì œ ì˜¤ë¥˜:', error);
      }
    }
    
    async function sendCommand(command) {
      if (!isConnected || !writer) {
        updateStatus('âš ï¸ ì‹œë¦¬ì–¼ì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ', '#feca57');
        return;
      }
      
      try {
        const encoder = new TextEncoder();
        const data = encoder.encode(command + '\n');
        await writer.write(data);
        console.log('ì „ì†¡ ì„±ê³µ:', command);
        
        // ëª…ë ¹ì–´ì— ë”°ë¼ í•œê¸€ í‘œì‹œ
        let displayText = command;
        if (command === "FAN_ON") displayText = "ì„ í’ê¸° ì‘ë™!";
        else if (command === "FAN_OFF") displayText = "ì„ í’ê¸° ë©ˆì¶¤!";
        
        document.getElementById('lastCommand').textContent = `ë§ˆì§€ë§‰ ëª…ë ¹: ${displayText}`;
      } catch (error) {
        updateStatus('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + error.message, '#ff6b6b');
        console.error('ì „ì†¡ ì˜¤ë¥˜:', error);
      }
    }
    
    async function startSystem() {
      if (!isConnected) {
        alert('ë¨¼ì € ì‹œë¦¬ì–¼ ì—°ê²°ì„ í•˜ì„¸ìš”!');
        return;
      }
      
      // tmImage ë¡œë”© í™•ì¸
      if (typeof tmImage === 'undefined') {
        alert('âŒ Teachable Machine ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const input = document.getElementById("modelURL").value.trim();
      if (!input.startsWith("https://")) {
        alert("Teachable Machine ì£¼ì†Œë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }
      
      const modelURL = input + "model.json";
      const metadataURL = input + "metadata.json";
      
      try {
        updateStatus('ëª¨ë¸ ë¡œë”© ì¤‘...', '#feca57');
        model = await tmImage.load(modelURL, metadataURL);
        console.log('Model loaded:', model);
        
        // í´ë˜ìŠ¤ ê°œìˆ˜ í™•ì¸
        console.log('í´ë˜ìŠ¤ ê°œìˆ˜:', model.getClassLabels().length);
        console.log('í´ë˜ìŠ¤ ì´ë¦„ë“¤:', model.getClassLabels());
        
      } catch (err) {
        updateStatus('âŒ ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨', '#ff6b6b');
        alert("ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        console.error(err);
        return;
      }
      
      // ì›¹ìº  ì„¤ì •
      webcam = new tmImage.Webcam(200, 200, true);
      try {
        updateStatus('ì›¹ìº  ì„¤ì • ì¤‘...', '#feca57');
        await webcam.setup();
        await webcam.play();
        
        // ì›¹ìº  í™”ë©´ í‘œì‹œ
        const container = document.getElementById('webcam-container');
        const videoElement = document.getElementById('webcam');
        videoElement.style.display = 'none';
        
        webcam.canvas.style.border = '3px solid #fff';
        webcam.canvas.style.borderRadius = '15px';
        container.appendChild(webcam.canvas);
        
        updateStatus('ğŸ¥ ì‹œìŠ¤í…œ ë™ì‘ ì¤‘! ì†ë™ì‘ìœ¼ë¡œ ì„ í’ê¸°ë¥¼ ì œì–´í•˜ì„¸ìš”!', '#4ecdc4');
        document.getElementById('predictionInfo').style.display = 'block';
        
        // ì‹œì‘ ì‹ í˜¸ ì „ì†¡
        await sendCommand("START");
        
      } catch (e) {
        updateStatus('âŒ ì›¹ìº  ì˜¤ë¥˜', '#ff6b6b');
        alert("ì›¹ìº  ì˜¤ë¥˜: ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        return;
      }
      
      requestAnimationFrame(loop);
    }
    
    async function loop() {
      if (!webcam || !webcam.canvas) return;
      
      webcam.update();
      const prediction = await model.predict(webcam.canvas);
      
      // ëª¨ë“  ì˜ˆì¸¡ ê²°ê³¼ ë¡œê·¸
      console.log('ì˜ˆì¸¡ ê²°ê³¼:', prediction.map(p => `${p.className}: ${(p.probability * 100).toFixed(1)}%`));
      
      // ê°€ì¥ ë†’ì€ í™•ë¥ ì˜ í´ë˜ìŠ¤ ì°¾ê¸°
      let maxProb = 0;
      let maxIndex = 0;
      for (let i = 0; i < prediction.length; i++) {
        if (prediction[i].probability > maxProb) {
          maxProb = prediction[i].probability;
          maxIndex = i;
        }
      }
      
      const className = prediction[maxIndex].className;
      const confidence = (maxProb * 100).toFixed(1);
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('currentPrediction').textContent = `ì¸ì‹: ${className}`;
      document.getElementById('confidenceLevel').textContent = `ì‹ ë¢°ë„: ${confidence}%`;
      
      // ì„ í’ê¸° ì œì–´ ë¡œì§ (ì„ê³„ê°’ 0.8)
      let result = "";
      if (maxProb > 0.8) {
        // í´ë˜ìŠ¤ì— ë”°ë¥¸ ì œì–´ (í‹°ì²˜ë¸” ë¨¸ì‹ ì—ì„œ ì„¤ì •í•œ ìˆœì„œì— ë§ê²Œ ì¡°ì •)
        if (className.includes("open") || className.includes("í¼ì¹¨") || className.includes("ì†ë°”ë‹¥") || maxIndex === 2) {
          result = "FAN_ON";
        } else if (className.includes("fist") || className.includes("ì£¼ë¨¹") || className.includes("closed") || maxIndex === 0 || maxIndex === 1) {
          result = "FAN_OFF";
        }
      }
      
      // ì´ì „ ê²°ê³¼ì™€ ë‹¤ë¥¼ ë•Œë§Œ ì „ì†¡
      if (result !== previousLabel && result !== "") {
        previousLabel = result;
        console.log('ì „ì†¡:', result);
        
        await sendCommand(result);
        updateStatus(`ğŸ“¤ ${result === 'FAN_ON' ? 'ì„ í’ê¸° ì‘ë™!' : 'ì„ í’ê¸° ë©ˆì¶¤'} ëª…ë ¹ ì „ì†¡!`, '#4ecdc4');
      }
      
      requestAnimationFrame(loop);
    }
    
    // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± í™•ì¸
    if (!('serial' in navigator)) {
      updateStatus('âŒ ì›¹ ì‹œë¦¬ì–¼ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•˜ì„¸ìš”.', '#ff6b6b');
    }
    
    // í˜ì´ì§€ ë‹«ì„ ë•Œ ì—°ê²° í•´ì œ
    window.addEventListener('beforeunload', disconnectSerial);
  </script>
</body>
</html>